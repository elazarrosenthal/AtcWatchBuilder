# give args should fail if $1 exists but we don't
if [ $# != 1 ]
then 
	echo "usage: setup newdir"
fi

#create build directory
Workdir=$1
mkdir $Workdir
cd $Workdir 

# setup needed librarys that we have to extract
mkdir -p Arduino/libraries/

#make a setenv file to help users later
echo export  HOME=`pwd` > setenv
echo export  PATH=$PATH:`pwd`/.local/bin/ >> setenv
chmod +x setenv
#make a build file to help users later
echo export  HOME=`pwd` > build
echo export  PATH=$PATH:`pwd`/.local/bin/ >> build
echo cd `pwd` >> build
echo './arduino-cli compile --clean -e -b nRF52D6Fitness:nRF5:dsd6Watch ATCwatch/ATCwatch/' >> build
chmod +x build

#change HOME to be here to keep real HOME clean all files in this dir
export HOME=`pwd`

# install local standalone copy of nrfutil
pip3 install wheel --user
pip3 install adafruit-nrfutil --user
# add to PATH
export PATH=$PATH:$HOME/.local/bin

####
#### get arduino-cli
####
#donwload
wget --no-check-certificate  https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
# extract
tar xvf arduino-cli_latest_Linux_64bit.tar.gz  arduino-cli
rm  arduino-cli_latest_Linux_64bit.tar.gz 

####
#### get D6Arduino # we need for lv_arduino version that is not available anymore
####
# comment out for speed and use cp when testing 
# wget --no-check-certificate  https://atcnetz.de/downloads/D6Arduino.rar
# copy local copy to speed up if we have 
# cp /home/elazar2/D6Arduino.rar .

# extract lv_arduino 2.15 (cant get from github)
# unrar x D6Arduino.rar D6Arduino/portable/sketchbook/libraries/lv_arduino-master 
# mv  D6Arduino/portable/sketchbook/libraries/lv_arduino-master  Arduino/libraries/.

# clean up  
# rm -rf    D6Arduino/ D6Arduino.rar 

####
#### get HRS3300-Arduino-Library
####
git clone https://github.com/atc1441/HRS3300-Arduino-Library.git
mv HRS3300-Arduino-Library Arduino/libraries/
# git clone https://github.com/lvgl/lv_arduino.git
git clone git@github.com:elazarrosenthal/lv_arduino.git
(cd lv_arduino; git fetch --tags;  git checkout atcwatch)
mv  lv_arduino Arduino/libraries/



# get ATC WATCH archive
git clone https://github.com/atc1441/ATCwatch.git

./arduino-cli config init
./arduino-cli config add board_manager.additional_urls https://atc1441.github.io/D6Library/package_nRF5_boards_index.json
./arduino-cli core update-index

# this will fail due to error with file on web remove & and cp below wehn fixed
./arduino-cli core install nRF52D6Fitness:nRF5 & 

### due to error in index file on web the above will fail and we need to use a local copy
# remove wne fixed
wait
cp ../package_nRF5_boards_index.json .arduino15/package_nRF5_boards_index.json
./arduino-cli core install nRF52D6Fitness:nRF5 
#  remove above when fixed
./arduino-cli core update-index


###
### edit files to allow for .a from HRS code
###
# make backup of file to edit
cp .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt.orig
cp .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt.new

# add line 
echo "compiler.libraries.ldflags=" >> .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt.new
# append to line 
sed 's/combine.pattern.*/& \{compiler.libraries.ldflags\}/'  < .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt.new > .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt.new2

#  overwrite file with changes
cp .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt.new2 .arduino15/packages/nRF52D6Fitness/hardware/nRF5/0.7.5/platform.txt 


####
#### buildit 
####
./arduino-cli  board attach -b nRF52D6Fitness:nRF5:dsd6Watch  ATCwatch/ATCwatch/
./arduino-cli compile --clean -e -b nRF52D6Fitness:nRF5:dsd6Watch ATCwatch/ATCwatch/

